## 安装

```shell
pnpm add pinia
```



## 挂载Pinia到vue应用

```js
import { createApp } from 'vue';
import { createPinia } from 'pinia';
import App from './App.vue';

const app = createApp(App);
const pinia = createPinia();

app.use(pinia);

app.mount('#app');
```



```js
import { defineStore } from 'pinia';

const useXxxStore = defineStore(唯一ID, option对象 或 setup函数);
```



## 选项式

### 创建Store

```js
import { defineStore } from 'pinia';

export const useCounterStore = defineStore('counter', {
    state: () => ({ // 等价于组件配置对象中data
        count: 0
    }),
    getters: { // 等价于组件配置对象中computed
        doubleCount(state){
            return state.count * 2;
        },
        doublePlusOnw(){
            return this.doubleCount + 1;
        }
    },
    actions: { // 等价于组件配置对象中methods
        increment() {
            // this等价于当前Store实例对象
            this.count++;
        },
        async asyncIncrement() {
            await new Promise(resolve => setTimeout(resolve, 1E3));
            this.increment();
        },
        // 可以传递任何类型的数据，任何数量参数
        plus(num){
            this.count += num;
            // 可以返回任何类型的数据
        }
    }
});
```



## 组合式

### 创建Store

```js
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';

export const useCounterStore = defineStore('counter', () => {
    const count = ref(0);
    const doubleCount = computed(() => count.value * 2);
    
    const increment = () => count.value++;
    const asyncIncrement = async () => {
    	await new Promise(resolve => setTimeout(resolve, 1E3));
        increment();
    };
    
    return {
        count,
        doubleCount,
        increment,
        asyncIncrement
    }
});
```

> - `ref`和`reactive`即为Store的`state`。
> - `computed`即为Store的`getters`。





## 使用Store

```vue
<script setup>
import { useCounterStore } from '@/store';
import { storeToRefs } from 'pinia';

const store = useCounterStore();
const { count, doubleCount } storeToRefs(store);
const { increment, asyncIncrement } = store;
</script>
```

> `storeToRefs`会将Store中的响应式数据，通过`ref`包裹，解决在解构时失去响应式。
>
> 组合式和选项式区别：
>
> - 组合式Store中，未暴露`$reset`、`$patch`等成员，需要通过手动实现（插件）。
> - 选项式Store中，存在`$store`、`$patch`等成员。

> - `store.$reset`方法：将Store状态重置为初始值。
> - `store.$patch`方法：修改Store状态。
>
> ```js
> // 可以一次性修改Store多个状态数据
> store.$patch({
>     count: 3
> });
> 
> // 支持传递回调函数
> store.$patch((state) => {
>     state.count = 3;
> })
> ```
>
> - `store.$state`属性，表示Store中的state。
> - `store.$subscribe`方法，监听Store中的state的变化。只要是Store的state变化，就会执行`$subscribe`监听的回调函数。
>
> ```js
> cartStore.$subscribe((mutation, state) => {
>   // import { MutationType } from 'pinia'
>   mutation.type // 'direct' | 'patch object' | 'patch function'
>   // 和 cartStore.$id 一样
>   mutation.storeId // 'cart'
>   // 只有 mutation.type === 'patch object'的情况下才可用
>   mutation.payload // 传递给 cartStore.$patch() 的补丁对象。
> 
>   // 每当状态发生变化时，将整个 state 持久化到本地存储。
>   localStorage.setItem('cart', JSON.stringify(state))
> })
> ```
>
> - `store.$onAction`方法，监听Store中`action`方法调用。针对`action`一些后续处理：
>   - `onError`：`action`抛出异常或返回Promise为rejected。
>   - `after`：`action`正常执行后的后续处理。





## 插件



## 组件外使用Store

### 单页面应用

> 使用Store之前，Pinia实例必须得已注册。

1. 在Pinia实例注册后，使用Store。

   ```js
   import { createApp } from 'vue'
   import { createPinia } from 'pinia'
   import App from './App.vue'
   
   const app = createApp(App);
   
   app.use(pinia); // pinia注册
   
   app.mount('#app');
   
   // 使用Store
   ```

   

2. 在vue router的导航守卫中使用Store。

   ```js
   import { createRouter } from 'vue-router'
   
   const router = createRouter({
       // ...
   });
   
   router.beforeEach((to, from, next) => {
       // 使用Store
   })
   ```

   

























